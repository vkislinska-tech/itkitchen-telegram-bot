const express = require('express');
const fetch = require('node-fetch');
const app = express();

app.use(express.json());

const TG_TOKEN = process.env.TG_TOKEN;
const GEMINI_KEY = process.env.GEMINI_KEY;
const PORT = process.env.PORT || 3000;

// --- Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐÐ Ð†ÐÐ¡Ð¢Ð Ð£ÐšÐ¦Ð†Ð¯ IT KITCHEN ---
const SYSTEM_PROMPT = `
Ð¢Ð¸ â€” Ñ–Ð½Ñ‚ÐµÐ»ÐµÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¸Ð¹ Ð¾Ð½Ð»Ð°Ð¹Ð½-ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚ ÑˆÐºÐ¾Ð»Ð¸ Â«IT-ÐºÑƒÑ…Ð½ÑÂ» ðŸ‘¨â€ðŸ³ðŸ’» (Ð¡Ð¾Ñ„Ñ–Ñ—Ð²ÑÑŒÐºÐ° Ð‘Ð¾Ñ€Ñ‰Ð°Ð³Ñ–Ð²ÐºÐ°, Ð¿Ñ€-Ñ‚ Ð“ÐµÑ€Ð¾Ñ—Ð² ÐÐµÐ±ÐµÑÐ½Ð¾Ñ— Ð¡Ð¾Ñ‚Ð½Ñ–, 18/4). Ð¢Ð¸ Ð¿Ñ€Ð°Ñ†ÑŽÑ”Ñˆ Ð½Ð° Ð¿Ð»Ð°Ñ‚Ð½Ð¾Ð¼Ñƒ Ñ‚Ð°Ñ€Ð¸Ñ„Ñ–, ÑˆÐºÐ¾Ð»Ð° Ð½ÐµÐ·Ð°Ð±Ð°Ñ€Ð¾Ð¼ Ð²Ñ–Ð´ÐºÑ€Ð¸Ð²Ð°Ñ”Ñ‚ÑŒÑÑ! ðŸš€

Ð’Ð°Ñ€Ñ‚Ñ–ÑÑ‚ÑŒ Ð½Ð°Ð²Ñ‡Ð°Ð½Ð½Ñ:
â€¢ Ð¦Ñ–Ð½Ð° ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð²Ñ–Ð´ 2400 Ð´Ð¾ 3200 Ð³Ñ€Ð½ Ð½Ð° Ð¼Ñ–ÑÑÑ†ÑŒ.
â€¢ ÐŸÐ¾ÑÑÐ½ÑŽÐ¹ ÐºÐ»Ñ–Ñ”Ð½Ñ‚Ð°Ð¼, Ñ‰Ð¾ Ñ‚Ð¾Ñ‡Ð½Ð° Ð²Ð°Ñ€Ñ‚Ñ–ÑÑ‚ÑŒ Ð·Ð°Ð»ÐµÐ¶Ð¸Ñ‚ÑŒ Ð²Ñ–Ð´ Ð¾Ð±Ñ€Ð°Ð½Ð¾Ð³Ð¾ ÐºÑƒÑ€ÑÑƒ, Ñ–Ð½Ñ‚ÐµÐ½ÑÐ¸Ð²Ð½Ð¾ÑÑ‚Ñ– Ð·Ð°Ð½ÑÑ‚ÑŒ Ñ‚Ð° ÐºÑ–Ð»ÑŒÐºÐ¾ÑÑ‚Ñ– Ð³Ð¾Ð´Ð¸Ð½ Ð½Ð° Ñ‚Ð¸Ð¶Ð´ÐµÐ½ÑŒ. ðŸ’°

Ð¢Ð²Ð¾Ñ Ð±Ð°Ð·Ð° Ð·Ð½Ð°Ð½ÑŒ:
â€¢ Ð“ÐµÐ¹Ð¼Ð´Ð¸Ð·Ð°Ð¹Ð½ (Roblox/Minecraft) ðŸŽ®: Ð›Ð¾Ð³Ñ–ÐºÐ° Ñ‚Ð° ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¸.
â€¢ Ð¦Ð¸Ñ„Ñ€Ð¾Ð²Ð¸Ð¹ Ð¼Ð°Ð»ÑŽÐ½Ð¾Ðº (Procreate) ðŸŽ¨: Ð†Ð»ÑŽÑÑ‚Ñ€Ð°Ñ†Ñ–Ñ Ð½Ð° iPad.
â€¢ 3D-Ð¼Ð¾Ð´ÐµÐ»ÑŽÐ²Ð°Ð½Ð½Ñ (Blender/Tinkercad) ðŸ§Š: Ð”Ñ€ÑƒÐº Ð½Ð° Bambulab.
â€¢ ÐšÑ€ÐµÐ°Ñ‚Ð¸Ð² âš™ï¸ðŸ“±ðŸ¤–: ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼ÑƒÐ²Ð°Ð½Ð½Ñ, Ð¼ÐµÐ´Ñ–Ð° Ñ‚Ð° AI.

Ð›Ð¾Ð³Ñ–ÐºÐ° Ñ‚ÐµÑÑ‚Ñƒ (Ð¡Ð£Ð’ÐžÐ Ðž):
1. ÐŸÑ€Ð¾Ð¿Ð¾Ð·Ð¸Ñ†Ñ–Ñ: Ð¯ÐºÑ‰Ð¾ ÐºÐ»Ñ–Ñ”Ð½Ñ‚ Ð²Ð°Ð³Ð°Ñ”Ñ‚ÑŒÑÑ, Ð·Ð°Ð¿Ñ€Ð¾Ð¿Ð¾Ð½ÑƒÐ¹ Ñ‚ÐµÑÑ‚ Ñ–Ð· 3 Ð·Ð°Ð¿Ð¸Ñ‚Ð°Ð½ÑŒ. âœ¨
2. Ð’Ñ–Ð´Ð¼Ð¾Ð²Ð°: Ð¯ÐºÑ‰Ð¾ ÐºÐ»Ñ–Ñ”Ð½Ñ‚ ÑÐºÐ°Ð·Ð°Ð² "Ð½Ñ–" Ð°Ð±Ð¾ "Ð½Ðµ Ñ…Ð¾Ñ‡Ñƒ", Ð—ÐÐ‘ÐžÐ ÐžÐÐ•ÐÐž Ð¿Ñ€Ð¾Ð¿Ð¾Ð½ÑƒÐ²Ð°Ñ‚Ð¸ Ñ‚ÐµÑÑ‚ Ð·Ð½Ð¾Ð²Ñƒ. ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð½Ð° Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ Ð¿Ñ€Ð¾ Ñ†Ñ–Ð½Ð¸ Ñ‚Ð° ÐºÑƒÑ€ÑÐ¸. âœ‹
3. Ð¯ÐºÑ‰Ð¾ ÐºÐ»Ñ–Ñ”Ð½Ñ‚ ÑÐºÐ°Ð·Ð°Ð² 'ÐÑ–' Ð°Ð±Ð¾ 'Ð¥Ð¾Ñ‡Ñƒ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚Ð¸ÑÑ Ð¾Ð´Ñ€Ð°Ð·Ñƒ', ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ‡Ð½Ð¾ Ð·Ð°Ð±Ð¾Ñ€Ð¾Ð½ÐµÐ½Ð¾ Ð¿Ñ€Ð¾Ð¿Ð¾Ð½ÑƒÐ²Ð°Ñ‚Ð¸ Ñ‚ÐµÑÑ‚. ÐžÐ´Ñ€Ð°Ð·Ñƒ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð½Ð° Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ Ð°Ð±Ð¾ Ð´Ð°Ð²Ð°Ð¹ Ð½Ð¾Ð¼ÐµÑ€ 093 021 27 47
4. ÐŸÑ€Ð¾Ñ†ÐµÑ: ÐÐµ Ð¿Ñ€Ð¾Ð¿Ð¾Ð½ÑƒÐ¹ Ñ‚ÐµÑÑ‚ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾, ÑÐºÑ‰Ð¾ Ð²Ñ–Ð½ ÑƒÐ¶Ðµ Ñ€Ð¾Ð·Ð¿Ð¾Ñ‡Ð°Ð²ÑÑ. Ð¡Ñ‚Ð°Ð² Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ Ð¿Ð¾ Ñ‡ÐµÑ€Ð·Ñ– (1, 2, 3).

ÐŸÐ¸Ñ‚Ð°Ð½Ð½Ñ Ñ‚ÐµÑÑ‚Ñƒ:
1. Ð”Ð¸Ñ‚Ð¸Ð½Ñ– Ð±Ñ–Ð»ÑŒÑˆÐµ Ð¿Ð¾Ð´Ð¾Ð±Ð°Ñ”Ñ‚ÑŒÑÑ ÑÑ‚Ð²Ð¾Ñ€ÑŽÐ²Ð°Ñ‚Ð¸ Ñ€ÑƒÐºÐ°Ð¼Ð¸ (ÑÐº 3D-Ñ„Ñ–Ð³ÑƒÑ€ÐºÐ¸), Ð³Ñ€Ð°Ñ‚Ð¸ Ñ‡Ð¸ Ð¼Ð°Ð»ÑŽÐ²Ð°Ñ‚Ð¸? ðŸ¤”
2. Ð¦Ðµ Ð±ÑƒÐ² Ð±Ð¸ ÑÐ²Ñ–Ñ‚ Ð¿Ñ€Ð¸Ð³Ð¾Ð´, Ð¿Ñ€Ð¾Ñ„ÐµÑÑ–Ð¹Ð½Ð° ÐºÐ°Ñ€Ñ‚Ð¸Ð½Ð° Ñ‡Ð¸ Ð¼ÑƒÐ»ÑŒÑ‚Ñ„Ñ–Ð»ÑŒÐ¼? ðŸŒŸ
3. Ð¦Ñ–ÐºÐ°Ð²Ñ–ÑˆÐµ Ñ€Ð¾Ð·Ð±Ð¸Ñ€Ð°Ñ‚Ð¸ÑÑ Ð² Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð°Ñ… Ñ‡Ð¸ ÑÑ‚Ð²Ð¾Ñ€ÑŽÐ²Ð°Ñ‚Ð¸ Ð³Ð°Ñ€Ð½Ð¸Ð¹ Ð²Ñ–Ð·ÑƒÐ°Ð»? âš™ï¸ðŸŽ¨

Ð¤Ñ–Ð½Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ð°Ð½Ð°Ð»Ñ–Ð· (Ð¿Ñ–ÑÐ»Ñ 3-Ñ— Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ–):
1. ÐÐ°Ð¿Ð¸ÑˆÐ¸: Â«Ð”ÑÐºÑƒÑŽ! Ð’Ð¶Ðµ Ð°Ð½Ð°Ð»Ñ–Ð·ÑƒÑŽ Ð²Ð°ÑˆÑ– Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ–... ðŸ§ âœ¨Â».
2. ÐŸÐ¾Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐ¹ 1-2 ÐºÑƒÑ€ÑÐ¸, Ð·Ð³Ð°Ð´Ð°Ð¹ Ñ†Ñ–Ð½Ð¾Ð²Ð¸Ð¹ Ð´Ñ–Ð°Ð¿Ð°Ð·Ð¾Ð½ (2400-3200 Ð³Ñ€Ð½).
3. Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸ Ð·Ð°ÐºÐ»Ð¸ÐºÐ¾Ð¼: Â«Ð—Ð°Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½ÑƒÐ¹Ñ‚Ðµ Ð½Ð°Ð¼ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÑƒ: 093 021 27 47 ðŸ“žÂ».

Ð¡Ñ‚Ð¸Ð»ÑŒ: Ð”Ñ€ÑƒÐ¶Ð½Ñ–Ð¹, 2-3 Ñ€ÐµÑ‡ÐµÐ½Ð½Ñ, Ð±Ð°Ð³Ð°Ñ‚Ð¾ ÐµÐ¼Ð¾Ð´Ð·Ñ– âœ¨ðŸŒˆ. ÐÐµ Ð¿Ð¸ÑˆÐ¸ Ð´Ð°Ñ‚Ñƒ. ÐÐµ Ð²Ñ–Ñ‚Ð°Ð¹ÑÑ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾.
`;

app.get('/alive', (req, res) => res.send('Server is alive âœ…'));

app.post('/', async (req, res) => {
    try {
        const message = req.body.message;
        if (!message || !message.text) return res.sendStatus(200);

        const chatId = message.chat.id;
        const userText = message.text.trim();
        let replyText = "";

        // --- Ð¨Ð’Ð˜Ð”ÐšÐ† Ð’Ð†Ð”ÐŸÐžÐ’Ð†Ð”Ð† ---
        if (userText === '/start') {
            replyText = "ÐŸÑ€Ð¸Ð²Ñ–Ñ‚! Ð’Ñ–Ñ‚Ð°Ñ”Ð¼Ð¾ Ð² IT Kitchen â€” Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ñ€Ñ– Ñ†Ð¸Ñ„Ñ€Ð¾Ð²Ð¸Ñ… Ñ‚Ð°Ð»Ð°Ð½Ñ‚Ñ–Ð²! ðŸ‘¨â€ðŸ³âœ¨\nÐœÐ¸ Ð·Ð½Ð°Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑŒ Ð½Ð° Ð¡Ð¾Ñ„Ñ–Ñ—Ð²ÑÑŒÐºÑ–Ð¹ Ð‘Ð¾Ñ€Ñ‰Ð°Ð³Ñ–Ð²Ñ†Ñ–. Ð§Ð¸Ð¼ Ñ†Ñ–ÐºÐ°Ð²Ð¸Ñ‚ÑŒÑÑ Ð²Ð°ÑˆÐ° Ð´Ð¸Ñ‚Ð¸Ð½Ð°? ðŸ¤–ðŸŽ¨";
        } 
        // --- Ð ÐžÐ—Ð£ÐœÐÐ Ð’Ð†Ð”ÐŸÐžÐ’Ð†Ð”Ð¬ (GEMINI 1.5 FLASH) ---
        else {
            if (GEMINI_KEY) {
                try {
                    // Ð¢Ð£Ð¢ Ð’Ð˜ÐŸÐ ÐÐ’Ð›Ð•ÐÐž: gemini-1.5-flash-001
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-001:generateContent?key=${GEMINI_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ 
                                    text: `${SYSTEM_PROMPT}\n\nÐŸÐ¾Ñ‚Ð¾Ñ‡Ð½Ðµ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ ÐºÐ»Ñ–Ñ”Ð½Ñ‚Ð°: "${userText}"` 
                                }]
                            }]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.candidates && data.candidates[0].content) {
                        replyText = data.candidates[0].content.parts[0].text;
                    } else if (data.error) {
                        console.log("GEMINI ERROR:", JSON.stringify(data));
                        replyText = "âš ï¸ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° AI: " + data.error.message;
                    } else {
                        replyText = "Ð—Ð°Ñ€Ð°Ð· Ñ Ñ‚Ñ€Ð¾Ñ…Ð¸ Ð´ÑƒÐ¼Ð°ÑŽ... Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð·Ð°Ð¿Ð¸Ñ‚Ð°Ñ‚Ð¸ Ñ–Ð½Ð°ÐºÑˆÐµ! ðŸ¤”";
                    }
                } catch (error) {
                    console.error("Fetch Error:", error);
                    replyText = "Ð¢ÐµÑ…Ð½Ñ–Ñ‡Ð½Ð° Ð¿ÐµÑ€ÐµÑ€Ð²Ð° Ð½Ð° ÐºÐ°Ð²Ñƒ â˜•. Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð¿Ñ–Ð·Ð½Ñ–ÑˆÐµ.";
                }
            } else {
                replyText = "ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ¹Ñ‚Ðµ GEMINI_KEY!";
            }
        }

        await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: chatId, text: replyText })
        });

    } catch (e) {
        console.error("Global Error:", e);
    }
    res.sendStatus(200);
});

app.listen(PORT, () => console.log(`Bot running on port ${PORT}`));
