const express = require('express');
const fetch = require('node-fetch');
const app = express();

app.use(express.json());

const TG_TOKEN = process.env.TG_TOKEN;
const GEMINI_KEY = process.env.GEMINI_KEY;
const PORT = process.env.PORT || 3000;

// --- Ð¤Ð†Ð›ÐžÐ¡ÐžÐ¤Ð†Ð¯ Ð¢Ð Ð†ÐÐ¡Ð¢Ð Ð£ÐšÐ¦Ð†Ð‡ Ð”Ð›Ð¯ Ð“Ð•ÐÐ†Ð¯ ---
const SYSTEM_PROMPT = `
Ð¢Ð¸ â€” Ð¿Ñ€Ð¾Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¸Ð¹ Ð¼ÐµÐ½Ñ‚Ð¾Ñ€ Ñ‚Ð° ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚ ÑˆÐºÐ¾Ð»Ð¸ Â«IT-ÐºÑƒÑ…Ð½ÑÂ» ðŸ‘¨â€ðŸ³ðŸ’» (Ð¡Ð¾Ñ„Ñ–Ñ—Ð²ÑÑŒÐºÐ° Ð‘Ð¾Ñ€Ñ‰Ð°Ð³Ñ–Ð²ÐºÐ°, Ð¿Ñ€-Ñ‚ Ð“ÐµÑ€Ð¾Ñ—Ð² ÐÐµÐ±ÐµÑÐ½Ð¾Ñ— Ð¡Ð¾Ñ‚Ð½Ñ–, 18/4).

Ð¢Ð’ÐžÐ¯ ÐœÐ†Ð¡Ð†Ð¯: 
Ð—Ð°ÐºÐ¾Ñ…Ð°Ñ‚Ð¸ Ð±Ð°Ñ‚ÑŒÐºÑ–Ð² Ñƒ Ð¼Ð°Ð¹Ð±ÑƒÑ‚Ð½Ñ” Ñ—Ñ…Ð½Ñ–Ñ… Ð´Ñ–Ñ‚ÐµÐ¹ Ñ‡ÐµÑ€ÐµÐ· Ñ‚ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ñ–Ñ—. Ð¢Ð¸ Ð½Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð´Ð¾Ð²Ñ–Ð´Ð½Ð¸Ðº, Ñ‚Ð¸ â€” ÐµÐºÑÐ¿ÐµÑ€Ñ‚, ÑÐºÐ¸Ð¹ Ð¿Ð¾ÑÑÐ½ÑŽÑ” "ÐÐÐ’Ð†Ð©Ðž" Ñ†Ðµ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾.

Ð¢Ð’ÐžÐ¯ ÐŸÐ£Ð‘Ð›Ð†Ð§ÐÐ Ð‘ÐÐ—Ð Ð—ÐÐÐÐ¬:
â€¢ ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼ÑƒÐ²Ð°Ð½Ð½Ñ (Roblox/Minecraft): Ð¦Ðµ Ð½Ðµ Ñ–Ð³Ñ€Ð¸, Ñ†Ðµ Ð°Ñ€Ñ…Ñ–Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° Ð»Ð¾Ð³Ñ–ÐºÐ¸. Ð¦Ðµ Ð²Ñ‡Ð¸Ñ‚ÑŒ Ð´Ð¸Ñ‚Ð¸Ð½Ñƒ Ð´ÐµÐºÐ¾Ð¼Ð¿Ð¾Ð·Ð¸Ñ†Ñ–Ñ— â€” Ð²Ð¼Ñ–Ð½Ð½ÑŽ Ñ€Ð¾Ð·Ð±Ð¸Ð²Ð°Ñ‚Ð¸ Ð²ÐµÐ»Ð¸ÐºÑƒ ÑÐºÐ»Ð°Ð´Ð½Ñƒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ Ð½Ð° Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÑ– ÐºÑ€Ð¾ÐºÐ¸. ðŸŽ®
â€¢ Ð¦Ð¸Ñ„Ñ€Ð¾Ð²Ð¸Ð¹ Ð¼Ð°Ð»ÑŽÐ½Ð¾Ðº (Procreate): Ð¦Ðµ Ð²Ñ–Ð·ÑƒÐ°Ð»ÑŒÐ½Ð° ÐºÐ¾Ð¼ÑƒÐ½Ñ–ÐºÐ°Ñ†Ñ–Ñ. Ð£ ÑÐ²Ñ–Ñ‚Ñ–, Ð´Ðµ Ð¿Ð°Ð½ÑƒÑ” Ð²Ñ–Ð·ÑƒÐ°Ð», Ð²Ð¼Ñ–Ð½Ð½Ñ ÑÑ‚Ð²Ð¾Ñ€ÑŽÐ²Ð°Ñ‚Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ â€” Ñ†Ðµ ÐºÐ²Ð¸Ñ‚Ð¾Ðº Ñƒ Ð±ÑƒÐ´ÑŒ-ÑÐºÑƒ ÑÑƒÑ‡Ð°ÑÐ½Ñƒ Ð¿Ñ€Ð¾Ñ„ÐµÑÑ–ÑŽ. ðŸŽ¨
â€¢ 3D-Ð¼Ð¾Ð´ÐµÐ»ÑŽÐ²Ð°Ð½Ð½Ñ: Ð Ð¾Ð·Ð²Ð¸Ð²Ð°Ñ” Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð²Ðµ Ð¼Ð¸ÑÐ»ÐµÐ½Ð½Ñ, ÑÐºÐµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾ Ð½ÐµÐ¾Ð±Ñ…Ñ–Ð´Ð½Ðµ Ð¼Ð°Ð¹Ð±ÑƒÑ‚Ð½Ñ–Ð¼ Ñ–Ð½Ð¶ÐµÐ½ÐµÑ€Ð°Ð¼ Ñ‚Ð° Ð°Ñ€Ñ…Ñ–Ñ‚ÐµÐºÑ‚Ð¾Ñ€Ð°Ð¼. ðŸ§Š
â€¢ ÐšÑ€ÐµÐ°Ñ‚Ð¸Ð² Ñ‚Ð° AI: ÐœÐ¸ Ð²Ñ‡Ð¸Ð¼Ð¾ Ð½Ðµ Ð±Ð¾ÑÑ‚Ð¸ÑÑ Ð¨Ð†, Ð° ÐºÐµÑ€ÑƒÐ²Ð°Ñ‚Ð¸ Ð½Ð¸Ð¼. Ð¦Ðµ Ð½Ð°Ð²Ð¸Ñ‡ÐºÐ° â„–1 Ð´Ð»Ñ ÑƒÑÐ¿Ñ–Ñ…Ñƒ Ð² 2026 Ñ€Ð¾Ñ†Ñ–. ðŸ¤–

Ð¢Ð’ÐžÐ¯ Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð†Ð¯ "ÐÐšÐ¢Ð˜Ð’ÐÐ˜Ð™ ÐœÐ•ÐÐ¢ÐžÐ ":
1. Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð½Ð° Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ Ð¿Ñ€ÑÐ¼Ð¾, Ð°Ð»Ðµ Ð´Ð¾Ð´Ð°Ð²Ð°Ð¹ "Ñ†Ñ–ÐºÐ°Ð²Ð¸Ð¹ Ð³Ð°Ñ‡Ð¾Ðº" Ð¿Ñ€Ð¾ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑŒ.
2. Ð—Ð°Ð²Ð¶Ð´Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÑƒÐ¹ Ð·ÑƒÑÑ‚Ñ€Ñ–Ñ‡Ð½Ð¸Ð¼ Ð¿Ð¸Ñ‚Ð°Ð½Ð½ÑÐ¼, Ñ‰Ð¾Ð± Ð¿Ñ€Ð¾Ð´Ð¾Ð²Ð¶Ð¸Ñ‚Ð¸ Ð´Ñ–Ð°Ð»Ð¾Ð³.
   - ÐÐ°Ð¿Ñ€Ð¸ÐºÐ»Ð°Ð´: "Ð”Ð¾ Ñ€ÐµÑ‡Ñ–, Ñ…Ð¾Ñ‡ÐµÑ‚Ðµ Ð´Ñ–Ð·Ð½Ð°Ñ‚Ð¸ÑÑ, ÑÐº Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼ÑƒÐ²Ð°Ð½Ð½Ñ Ð´Ð¾Ð¿Ð¾Ð¼Ð°Ð³Ð°Ñ” Ð´Ð¸Ñ‚Ð¸Ð½Ñ– Ð· Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐ¾ÑŽ Ð² ÑˆÐºÐ¾Ð»Ñ–?"
   - ÐÐ±Ð¾: "Ð Ð¾Ð·Ð¿Ð¾Ð²Ñ–ÑÑ‚Ð¸ Ð²Ð°Ð¼, Ñ‡Ð¾Ð¼Ñƒ Ñ‚Ð²Ð¾Ñ€Ñ‡Ðµ Ð¼Ð¸ÑÐ»ÐµÐ½Ð½Ñ â€” Ñ†Ðµ Ñ”Ð´Ð¸Ð½Ð° Ñ€Ñ–Ñ‡, ÑÐºÑƒ Ð½Ðµ Ð·Ð¼Ð¾Ð¶Ðµ Ð·Ð°Ð¼Ñ–Ð½Ð¸Ñ‚Ð¸ Ð¶Ð¾Ð´ÐµÐ½ Ñ€Ð¾Ð±Ð¾Ñ‚?"

Ð›ÐžÐ“Ð†Ð¡Ð¢Ð˜ÐšÐ:
- Ð’Ð°Ñ€Ñ‚Ñ–ÑÑ‚ÑŒ: 2400-3200 Ð³Ñ€Ð½/Ð¼Ñ–Ñ. ðŸ’°
- Ð—Ð°Ð¿Ð¸Ñ/ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¸: 093 021 27 47 ðŸ“ž.
- Ð›Ð¾Ð³Ñ–ÐºÐ° Ñ‚ÐµÑÑ‚Ñƒ: Ð¯ÐºÑ‰Ð¾ ÐºÐ»Ñ–Ñ”Ð½Ñ‚ Ð²Ð°Ð³Ð°Ñ”Ñ‚ÑŒÑÑ, Ð·Ð°Ð¿Ñ€Ð¾Ð¿Ð¾Ð½ÑƒÐ¹ Ñ‚ÐµÑÑ‚ Ñ–Ð· 3 Ð·Ð°Ð¿Ð¸Ñ‚Ð°Ð½ÑŒ (ÑÑ‚Ð°Ð² Ð¿Ð¾ Ð¾Ð´Ð½Ð¾Ð¼Ñƒ!).

Ð¡Ð¢Ð˜Ð›Ð¬: ÐÐ°Ñ‚Ñ…Ð½ÐµÐ½Ð½Ð¸Ð¹, Ð»Ð°ÐºÐ¾Ð½Ñ–Ñ‡Ð½Ð¸Ð¹, Ð· ÐµÐ¼Ð¾Ð´Ð·Ñ–. ÐÐµ Ð¿Ð¸ÑˆÐ¸ Ð´Ð°Ñ‚Ñƒ. Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ â€” Ð´Ð¾ 5 Ñ€ÐµÑ‡ÐµÐ½ÑŒ. âœ¨
`;

app.get('/alive', (req, res) => res.send('Server is alive âœ…'));

app.post('/', async (req, res) => {
    try {
        const message = req.body.message;
        if (!message || !message.text) return res.sendStatus(200);

        const chatId = message.chat.id;
        const userText = message.text.trim();
        let replyText = "";

        if (userText.toLowerCase() === '/start') {
            replyText = "ÐŸÑ€Ð¸Ð²Ñ–Ñ‚! Ð’Ñ–Ñ‚Ð°Ñ”Ð¼Ð¾ Ð² IT Kitchen ðŸ‘¨â€ðŸ³âœ¨ Ð¢ÑƒÑ‚ Ð¼Ð¸ Ð³Ð¾Ñ‚ÑƒÑ”Ð¼Ð¾ Ð¼Ð°Ð¹Ð±ÑƒÑ‚Ð½Ñ” Ð²Ð»Ð°ÑÐ½Ð¸Ð¼Ð¸ Ñ€ÑƒÐºÐ°Ð¼Ð¸. Ð§Ð¸Ð¼ Ð·Ð°Ñ…Ð¾Ð¿Ð»ÑŽÑ”Ñ‚ÑŒÑÑ Ð²Ð°ÑˆÐ° Ð´Ð¸Ñ‚Ð¸Ð½Ð°? ÐœÐ¾Ð¶Ð»Ð¸Ð²Ð¾, Ð²Ð¾Ð½Ð° Ð¾Ð±Ð¾Ð¶Ð½ÑŽÑ” Ñ–Ð³Ñ€Ð¸ Ñ‡Ð¸ Ð¼Ð°Ð»ÑŽÐ²Ð°Ð½Ð½Ñ? ðŸ¤–ðŸŽ¨";
        } else {
            try {
                // Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ð¼Ð¾ Gemini 2.0 Flash Ñ‡ÐµÑ€ÐµÐ· v1beta (Ð½Ð°Ð¹ÑÐ²Ñ–Ð¶Ñ–ÑˆÐ¸Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `${SYSTEM_PROMPT}\nÐŸÐ¸Ñ‚Ð°Ð½Ð½Ñ Ð²Ñ–Ð´ ÐºÐ»Ñ–Ñ”Ð½Ñ‚Ð°: ${userText}` }] }]
                    })
                });

                const data = await response.json();

                if (data.candidates && data.candidates[0].content) {
                    replyText = data.candidates[0].content.parts[0].text;
                } else if (data.error && data.error.code === 429) {
                    replyText = "ÐžÐ¹, Ñƒ Ð½Ð°Ñ Ð·Ð°Ñ€Ð°Ð· ÑÐ¿Ñ€Ð°Ð²Ð¶Ð½Ñ–Ð¹ Ð°Ð¶Ñ–Ð¾Ñ‚Ð°Ð¶ Ð½Ð° IT-ÐºÑƒÑ…Ð½Ñ–! ðŸ”¥ ÐŸÐ¾Ñ‡ÐµÐºÐ°Ð¹Ñ‚Ðµ 30 ÑÐµÐºÑƒÐ½Ð´, Ñ– Ñ Ñ€Ð¾Ð·Ð¿Ð¾Ð²Ñ–Ð¼ Ð²Ð°Ð¼ Ñ‰Ð¾ÑÑŒ Ð´ÑƒÐ¶Ðµ Ñ†Ñ–ÐºÐ°Ð²Ðµ. ÐÐ±Ð¾ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½ÑƒÐ¹Ñ‚Ðµ: 093 021 27 47 ðŸ“ž";
                } else {
                    replyText = "Ð—Ð°Ð¼Ð¸ÑÐ»Ð¸Ð²ÑÑ Ð½Ð°Ð´ Ð²Ð°ÑˆÐ¸Ð¼ Ð¿Ð¸Ñ‚Ð°Ð½Ð½ÑÐ¼... ÐÐ°Ð¿Ð¸ÑˆÑ–Ñ‚ÑŒ Ð¼ÐµÐ½Ñ– Ñ‰Ðµ Ñ€Ð°Ð· Ñ‡ÐµÑ€ÐµÐ· Ð¼Ð¸Ñ‚ÑŒ, Ð¼Ð°ÑŽ Ñ‡ÑƒÐ´Ð¾Ð²Ñƒ Ñ–Ð´ÐµÑŽ Ð´Ð»Ñ Ð²Ð°Ñ! ðŸ¤”";
                    console.log("Error Log:", JSON.stringify(data));
                }
            } catch (err) {
                replyText = "Ð¢ÐµÑ…Ð½Ñ–Ñ‡Ð½Ð° Ð·Ð°Ð¼Ð¸Ð½ÐºÐ°. ÐœÐ¸ Ð²Ð¶Ðµ Ð»Ð°Ð³Ð¾Ð´Ð¸Ð¼Ð¾! Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ÑƒÐ¹Ñ‚Ðµ: 093 021 27 47 ðŸ“ž";
            }
        }

        await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: chatId, text: replyText })
        });

    } catch (e) { console.error(e); }
    res.sendStatus(200);
});

app.listen(PORT, () => console.log(`Mentor Bot 2.0 Flash running on ${PORT}`));
